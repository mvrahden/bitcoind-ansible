---
- name: Bitcoind | Set current version fact
  ansible.builtin.set_fact:
    _bitcoind_change_version: false # default

- name: Bitcoind | Validate implementation is supported
  ansible.builtin.fail:
    msg: >-
      bitcoind_implementation must be "core" or "knots", got "{{ bitcoind_implementation }}".
  when: bitcoind_implementation not in ['core', 'knots']

- name: Bitcoind | Set implementation-specific facts
  ansible.builtin.set_fact:
    _bitcoind_pgp_builders: >-
      {{ bitcoind_pgp_builders_pub_key_core
         if bitcoind_implementation == 'core'
         else bitcoind_pgp_builders_pub_key_knots }}
    _bitcoind_base_url: >-
      {{ 'https://bitcoincore.org/bin/bitcoin-core-' ~ bitcoind_version
         if bitcoind_implementation == 'core'
         else 'https://bitcoinknots.org/files/' ~ bitcoind_version.split('.')[0] ~ '.x/' ~ bitcoind_version }}
    _bitcoind_guix_sigs_base_url: >-
      {{ 'https://raw.githubusercontent.com/bitcoin-core/guix.sigs/main'
         if bitcoind_implementation == 'core'
         else 'https://raw.githubusercontent.com/bitcoinknots/guix.sigs/knots' }}

# Fix #2: GPG verification must be explicitly configured or explicitly skipped
- name: Bitcoind | Validate GPG verification is configured
  ansible.builtin.fail:
    msg: >-
      GPG builder keys must contain at least one GPG key for binary
      signature verification. Set bitcoind_skip_gpg_verification=true to bypass
      (not recommended).
  when:
    - _bitcoind_pgp_builders | length == 0
    - not (bitcoind_skip_gpg_verification | default(false) | bool)

# Fix #3: RPC credential must be provided — no hardcoded default
- name: Bitcoind | Validate RPC auth is configured
  ansible.builtin.fail:
    msg: >-
      bitcoind_rpc_auth must be set. Generate with:
      python3 share/rpcauth/rpcauth.py <username>
  when: bitcoind_rpc_auth | default('') | length == 0

- name: Bitcoind | Ensure dependencies are installed
  ansible.builtin.apt:
    update_cache: true
    name: "{{ item }}"
    state: present
  with_items:
    - gpg
    - dirmngr
  when:
    - _bitcoind_pgp_builders | length > 0
    - not (bitcoind_skip_gpg_verification | default(false) | bool)

- name: "Bitcoind | Ensure group '{{ bitcoind_group }}' exists"
  ansible.builtin.group:
    name: "{{ bitcoind_group }}"
    state: present

# Fix #7: Service account gets nologin shell
- name: "Bitcoind | Ensure user '{{ bitcoind_user }}' with a primary group of '{{ bitcoind_group }}' exists"
  ansible.builtin.user:
    name: "{{ bitcoind_user }}"
    group: "{{ bitcoind_group }}"
    state: present
    password: "*"
    shell: /usr/sbin/nologin
  when: "ansible_user is not defined or bitcoind_user != ansible_user"

- name: "Bitcoind | Ensure data device is mounted ('{{ bitcoind_data_mount_path }}')"
  ansible.posix.mount:
    path: "{{ bitcoind_data_mount_path }}"
    src: "{{ bitcoind_data_mount_device }}"
    fstype: "{{ bitcoind_data_mount_fstype }}"
    opts: "{{ bitcoind_data_mount_opts }}"
    state: mounted
  when: bitcoind_data_mount_device | length > 0

- name: "Bitcoind | Ensure Bitcoin data directory exists ('{{ bitcoind_data_dir }}')"
  ansible.builtin.file:
    path: "{{ bitcoind_data_dir }}"
    state: directory

# Fix #8: Data directory 0750 (not world-readable — may contain wallet files)
- name: "Bitcoind | Ensure Bitcoin data directory uses the correct permissions ('{{ bitcoind_data_dir }}')"
  ansible.builtin.file:
    path: "{{ bitcoind_data_dir }}"
    state: directory
    owner: "{{ bitcoind_user }}"
    group: "{{ bitcoind_group }}"
    mode: "0750"

- name: "Bitcoind | Load version cookie file"
  slurp:
    src: "{{ bitcoind_data_dir }}/.bitcoind.version"
  register: _bitcoind_version_cookie_file
  ignore_errors: true

- name: "Bitcoind | Determine version change from version cookie vs. configured version"
  set_fact:
    _bitcoind_change_version: "{{ (_bitcoind_version_cookie_file['content'] | b64decode | trim | split('\n') | last) != (bitcoind_version | string) }}"
  when: "not _bitcoind_version_cookie_file.failed"

- name: "Bitcoind | Debug detected version change from cookie"
  debug:
    msg: "{{ _bitcoind_change_version }}"

# ── Download, verify, and install Bitcoin (only on first install or version change) ──
- name: Bitcoind | Download, verify, and install Bitcoin
  when: _bitcoind_version_cookie_file.failed or _bitcoind_change_version | bool
  block:
    # Fix #5: Secure staging directory (unpredictable path, 0700, root-owned)
    - name: Bitcoind | Create secure staging directory
      ansible.builtin.tempfile:
        state: directory
        prefix: bitcoind_
      register: _bitcoind_staging

    # Fix #11: Dedicated GPG homedir (not the APT trusted keyring)
    - name: Bitcoind | Set GPG home directory fact
      ansible.builtin.set_fact:
        _bitcoind_gpg_home: "{{ _bitcoind_staging.path }}/gpg"

    - name: Bitcoind | Ensure GPG home directory exists
      ansible.builtin.file:
        path: "{{ _bitcoind_gpg_home }}"
        state: directory
        mode: "0700"

    - name: Bitcoind | Configure GPG keyserver
      ansible.builtin.copy:
        dest: "{{ _bitcoind_gpg_home }}/dirmngr.conf"
        content: "keyserver hkps://keys.openpgp.org\n"
        mode: "0600"

    - name: "Bitcoind | Download SHA256SUMS for Bitcoin v{{ bitcoind_version }}"
      ansible.builtin.get_url:
        url: "{{ _bitcoind_base_url }}/SHA256SUMS"
        dest: "{{ _bitcoind_staging.path }}/SHA256SUMS"
        http_agent: yourbtc-ansible

    - name: "Bitcoind | Verify signature with given keys"
      ansible.builtin.include_tasks: gpg.yml
      vars:
        gpg_user: "{{ item.name }}"
        gpg_id: "{{ item.id }}"
      with_items: "{{ _bitcoind_pgp_builders }}"
      when:
        - _bitcoind_pgp_builders | length > 0
        - not (bitcoind_skip_gpg_verification | default(false) | bool)

    # Fix #1: Extract checksum from the GPG-verified SHA256SUMS (not a fresh HTTP fetch)
    - name: "Bitcoind | Extract verified checksum for bitcoin-{{ bitcoind_version }}-{{ bitcoind_arch }}.tar.gz"
      ansible.builtin.shell:
        cmd: >-
          awk '/bitcoin-{{ bitcoind_version }}-{{ bitcoind_arch }}\.tar\.gz/{print $1; exit}'
          {{ _bitcoind_staging.path }}/SHA256SUMS
      register: _bitcoind_verified_checksum
      changed_when: false
      failed_when: _bitcoind_verified_checksum.stdout | length != 64

    - name: "Bitcoind | Download Bitcoin v{{ bitcoind_version }}"
      ansible.builtin.get_url:
        url: "{{ _bitcoind_base_url }}/bitcoin-{{ bitcoind_version }}-{{ bitcoind_arch }}.tar.gz"
        dest: "{{ _bitcoind_staging.path }}/bitcoin-{{ bitcoind_version }}-{{ bitcoind_arch }}.tar.gz"
        checksum: "sha256:{{ _bitcoind_verified_checksum.stdout }}"
        http_agent: yourbtc-ansible

    - name: "Bitcoind | Ensure extraction directory exists"
      ansible.builtin.file:
        path: "{{ _bitcoind_staging.path }}/bitcoin-{{ bitcoind_version }}"
        state: directory

    - name: "Bitcoind | Unpack Bitcoin v{{ bitcoind_version }}"
      ansible.builtin.unarchive:
        src: "{{ _bitcoind_staging.path }}/bitcoin-{{ bitcoind_version }}-{{ bitcoind_arch }}.tar.gz"
        dest: "{{ _bitcoind_staging.path }}/bitcoin-{{ bitcoind_version }}"
        remote_src: true
        extra_opts:
          - --strip-components=1

    - name: "Bitcoind | Ensure 'bitcoind-{{ bitcoind_network }}.service' systemd unit is stopped"
      ansible.builtin.systemd:
        name: bitcoind-{{ bitcoind_network }}.service
        state: stopped
      register: _bitcoind_systemd_stop
      when: _bitcoind_change_version
      failed_when:
        - _bitcoind_systemd_stop.failed
        - "'Could not find the requested service' not in _bitcoind_systemd_stop.msg"

    - name: "Bitcoind | Install binaries into '/usr/local/bin/*'"
      ansible.builtin.copy:
        src: "{{ _bitcoind_staging.path }}/bitcoin-{{ bitcoind_version }}/bin/"
        dest: /usr/local/bin/
        remote_src: true
        owner: root
        group: root
        mode: "0755"

  always:
    # gpg-agent creates socket files (S.gpg-agent*) that vanish asynchronously
    # on shutdown, causing rmtree ENOENT races. Kill it first.
    - name: "Bitcoind | Stop gpg-agent for staging cleanup"
      ansible.builtin.command:
        cmd: gpgconf --homedir {{ _bitcoind_gpg_home }} --kill gpg-agent
      failed_when: false
      changed_when: false
      when: _bitcoind_gpg_home is defined

    # Fix #6: Clean up all staging artifacts
    - name: "Bitcoind | Remove staging directory"
      ansible.builtin.file:
        path: "{{ _bitcoind_staging.path }}"
        state: absent
      when: _bitcoind_staging.path is defined

- name: "Bitcoind | Copy Bitcoin systemd file into '/lib/systemd/system/bitcoind-{{ bitcoind_network }}.service'"
  ansible.builtin.template:
    src: bitcoind.service.j2
    dest: /lib/systemd/system/bitcoind-{{ bitcoind_network }}.service
  notify:
    - Bitcoind | Ensure bitcoind systemd unit is restarted

- name: "Bitcoind | Ensure symbolic link from '{{ bitcoind_data_dir }}' to '/home/{{ bitcoind_user }}/.bitcoin' exists"
  ansible.builtin.file:
    src: "{{ bitcoind_data_dir }}"
    dest: /home/{{ bitcoind_user }}/.bitcoin
    state: link
    owner: "{{ bitcoind_user }}"
    group: "{{ bitcoind_group }}"

# Fix #4: mode 0640 — config contains rpcauth hash
# Fix #10: no_log — prevent rpcauth from leaking into Ansible output
- name: "Bitcoind | Copy bitcoin.conf file into '{{ bitcoind_data_dir }}/bitcoind.conf'"
  ansible.builtin.template:
    src: bitcoin.conf.j2
    dest: "{{ bitcoind_data_dir }}/bitcoind.conf"
    owner: "{{ bitcoind_user }}"
    group: "{{ bitcoind_group }}"
    mode: "0640"
  no_log: true
  notify:
    - Bitcoind | Ensure bitcoind systemd unit is restarted

- name: "Bitcoind | Ensure 'bitcoind-{{ bitcoind_network }}.service' systemd unit is enabled and started"
  ansible.builtin.systemd:
    name: bitcoind-{{ bitcoind_network }}.service
    daemon_reload: true
    enabled: true
    state: started
  register: _bitcoind_service_start

- name: "Bitcoind | Ensure version cookie file set"
  ansible.builtin.template:
    src: .bitcoind.version.j2
    dest: "{{ bitcoind_data_dir }}/.bitcoind.version"
    owner: "{{ bitcoind_user }}"
    group: "{{ bitcoind_group }}"
    mode: "0644"
  when: _bitcoind_service_start is not failed
